#!/usr/bin/env bash

# Catch misspecified out directory early
if [[ -z "${OUT_DIR}" && -d "${OUT_DIR}" ]]; then
  echo "${OUT_DIR} is not a directory"
  exit 1
fi
seed=0

gen_cmd="python -m gpsr_command_understanding.data.make_dataset -f"

# Just gen (Column 1)
${gen_cmd} --name gen -a --seed $seed
${gen_cmd} --name gen_logical -a -s .68 .12 .20 --use-logical-split --seed $seed

# Just paraphrase (Column 3)
${gen_cmd} --name para --paraphrasings data/paraphrasings.txt --seed $seed
${gen_cmd} --name para_logical --paraphrasings data/paraphrasings.txt --use-logical-split --match-logical-split data/gen_logical --seed $seed

# Gen + para (Column 4)
${gen_cmd} --name all --paraphrasings data/paraphrasings.txt -a --seed $seed
${gen_cmd} --name all_logical --paraphrasings data/paraphrasings.txt -a --use-logical-split --match-logical-split data/gen_logical --seed $seed

function run_with_data {
    local data="$1"
    local test_data="$2"
    if [[ -z "${test_data}" ]]; then
        # Default to the folder's test data
        test_data="data/${data}/test.txt"
    fi
    local results_dir="experiments/results_${data}"
    bash -c "sleep 10; tensorboard serve --logdir ${results_dir} --bind_all --port 6008" &
    ./scripts/train_all_models "${data}" experiments -t "data/${data}/train.txt" -v "data/${data}/val.txt"
    ./scripts/test_all_models "${results_dir}" "${test_data}"
    pkill tensorboard
    # Model archives can take up a lot of space. Use OUT_DIR to move them elsewhere
    if [[ -d "${OUT_DIR}" ]]; then
      set -x;
      mv -b --suffix=.bak "${results_dir}" "${OUT_DIR}"
      set -x;
    fi
}

export SEED=$seed
# Column 1
run_with_data gen
run_with_data gen_logical

# Column 2 (train on gen data, test on the standard paraphrase test set)
./scripts/test_all_models "experiments/results_gen" "data/para/test.txt"
./scripts/test_all_models "experiments/results_gen_logical" "data/para_logical/test.txt"

# Column 3
run_with_data para
run_with_data para_logical

# Column 4 (both gen and real data, but test on para only!)
run_with_data all "data/para/test.txt"
run_with_data all_logical "data/para_logical/test.txt"

